# Скрипт резервного копирования CommuniGate Pro

Этот Bash-скрипт предназначен для автоматизации резервного копирования данных сервера CommuniGate Pro. Скрипт создает ежедневные и месячные резервные копии, загружает их на FTP-сервер, управляет сроками хранения и отправляет уведомления по email с подробными логами.

## Возможности

- **Ежедневные резервные копии**: Архивирует директории `Accounts`, `SystemLogs`, `Settings` и отдельные домены (`Domains`) при их наличии, в сжатые файлы `.tar.gz`.
- **Месячные резервные копии**: Создает архивы 1-го числа каждого месяца, сохраняя до двух последних наборов.
- **Управление хранением**:
  - Удаляет локальные ежедневные архивы старше 7 дней.
  - Удаляет папки на FTP старше 7 дней.
  - Сохраняет только два последних набора месячных архивов.
- **Загрузка на FTP**: Безопасно отправляет архивы и логи на указанный FTP-сервер с автоматическим созданием директорий. Поддерживает нестандартные порты.
- **Уведомления по email**: Отправляет подробные отчеты через SMTP с логами во вложении.
- **Сжатие**: Использует `pigz` для ускоренного сжатия, если доступно, или `gzip` в противном случае.
- **Обработка ошибок**: Проверяет целостность архивов, контролирует свободное место на диске и логирует все операции.
- **Настраиваемость**: Легко редактируемая секция конфигурации для путей, FTP, email и сроков хранения.

## Требования

- **Операционная система**: Linux/Unix с Bash.
- **Зависимости**:
  - `bash`, `tar`, `curl`, `base64` (обязательно).
  - `pigz` (опционально, для ускоренного сжатия). (apt install pigz)
- **Права доступа**: Чтение директории данных CommuniGate, запись в директорию для резервных копий.
- **Сеть**: Доступ к FTP-серверу и SMTP-серверу для загрузки и отправки уведомлений.

## Установка

1. **Скачайте скрипт**:
   ```bash
   wget https://github.com/saym101/CommuniGate-backup/raw/refs/heads/main/communigate_backup.sh
   ```

2. **Установите права на выполнение**:
   ```bash
   chmod +x communigate_backup.sh
   ```

3. **Настройте конфигурацию**:
   Откройте `communigate_backup.sh` в текстовом редакторе и заполните секцию **Конфигурация пользователя** в начале файла. Основные переменные:
   - `BASE_DIR`: Путь к данным CommuniGate (например, `/var/CommuniGate`).
   - `BACKUP_BASE`: Локальная директория для резервных копий (например, `/backups/CommuniGate`).
   - `FTP_SERVER`, `FTP_PORT`, `FTP_USER`, `FTP_PASS`: Данные для доступа к FTP. Укажите `FTP_PORT`, если порт отличается от 21.
   - `FTP_BASE_DIR`: Путь на FTP для архивов (например, `/backups/CommuniGate`).
   - `NOTIFICATION_EMAIL`, `POSTMASTER_NAME`, `SMTP_SERVER`: Настройки email.
   - `MAIN_DOMAIN`: Основной домен для имени архива `Accounts` (например, `example.com`).

   Пример:
   ```bash
   BASE_DIR="/var/CommuniGate"
   BACKUP_BASE="/backups/CommuniGate"
   FTP_SERVER="ftp.example.com"
   FTP_PORT="2121"
   FTP_USER="ftp_user"
   FTP_PASS="your_secure_password"
   FTP_BASE_DIR="/backups"
   NOTIFICATION_EMAIL="admin@example.com"
   POSTMASTER_NAME="backup@example.com"
   SMTP_SERVER="smtp.example.com"
   MAIN_DOMAIN="example.com"
   ```

## Использование

1. **Тестовый запуск**:
   Выполните скрипт вручную, чтобы проверить конфигурацию:
   ```bash
   ./communigate_backup.sh
   ```

2. **Настройка cron**:
   Добавьте скрипт в `cron` для ежедневного выполнения (например, в 2:00):
   ```bash
   crontab -e
   ```
   Добавьте строку:
   ```bash
   0 2 * * * /path/to/communigate_backup.sh
   ```

3. **Проверка логов**:
   - Логи сохраняются в `$BACKUP_BASE/YYYY-MM-DD/backup.log` (например, `/backups/CommuniGate/2025-04-25/backup.log`).
   - Уведомления по email содержат лог во вложении и отправляются на `NOTIFICATION_EMAIL`.

## Настройки

Скрипт гибко настраивается. Основные параметры в секции **Системные настройки**:
- `RETENTION_DAYS` (по умолчанию: `7`): Срок хранения ежедневных архивов (локально и на FTP).
- `MONTHLY_RETENTION` (по умолчанию: `2`): Количество хранимых наборов месячных архивов.
- `REQUIRED_SPACE` (по умолчанию: `1024` МБ): Минимальное свободное место на диске.
- `SHOW_LOG` (по умолчанию: `true`): Выводить логи в консоль во время выполнения. ###### НЕ ЗАБЫВАЕМ ОТКЛЮЧАТЬ.
- `CLEAR_BACKUP_DIR` (по умолчанию: `false`): Очищать директорию ежедневных архивов перед запуском.
   При текущем значении `CLEAR_BACKUP_DIR=false` скрипт не удаляет файлы, созданные ранее текущей даты в /path/to/backups/ДАТА-АРХИВИРОВАНИЯ/, и просто добавляет новые. Архивы за предыдущие даты и месячные архивы не затрагиваются. Если вы хотите, чтобы скрипт очищал файлы за текущий день перед новым запуском, установите CLEAR_BACKUP_DIR=true.

В секции **Конфигурация пользователя** обратите внимание на:
- `FTP_PORT`: Позволяет указать нестандартный порт FTP-сервера (например, `2121`). По умолчанию `21`.

Подробные описания всех переменных см. в комментариях внутри скрипта.

## Структура резервных копий

- **Ежедневные архивы**:
  - Хранятся в `$BACKUP_BASE/YYYY-MM-DD/` (например, `/backups/CommuniGate/2025-04-25/`).
  - Файлы: `YYYY-MM-DD-HHMMSS_Accounts_<MAIN_DOMAIN>.tar.gz`, `SystemLogs.tar.gz`, `Settings.tar.gz`, `Domains-<domain>.tar.gz`.
- **Месячные архивы**:
  - Хранятся в `$BACKUP_BASE/Monthly/` (например, `/backups/CommuniGate/Monthly/`).
  - Файлы: `YYYY-MM-DD-Monthly_*.tar.gz`, создаются 1-го числа месяца.
- **FTP**:
  - Загружаются в `$FTP_BASE_DIR/YYYY-MM-DD/` (например, `/backups/2025-04-25/`).
  - Включают все ежедневные архивы и файл `backup.log`.

## Устранение неполадок

- **Логи**: Проверяйте `$BACKUP_BASE/YYYY-MM-DD/backup.log` для анализа ошибок.
- **Частые проблемы**:
  - **Ошибки FTP**: Проверьте `FTP_SERVER`, `FTP_PORT`, `FTP_USER`, `FTP_PASS`. Убедитесь, что FTP-сервер доступен на указанном порту.
  - **Ошибки email**: Проверьте `SMTP_SERVER` и адреса email. Тестируйте SMTP-соединение.
  - **Ошибки прав доступа**: Убедитесь, что есть права чтения для `BASE_DIR` и записи для `BACKUP_BASE`.
  - **Недостаток места**: Увеличьте `REQUIRED_SPACE` или освободите место на диске.
- **Отладка**: Установите `SHOW_LOG=true` для вывода логов в реальном времени.

## Как внести вклад

Приветствуются любые улучшения! Пожалуйста, создавайте issues или pull requests в [репозитории GitHub](https://github.com/saym101/CommuniGate-backup/blob/main/communigate_backup.sh). Предложения новых функций (например, поддержка SFTP или облачных хранилищ) приветствуются.

## Лицензия

Проект распространяется под [лицензией MIT](LICENSE). Вы можете свободно использовать, изменять и распространять скрипт с указанием авторства.

---

**Удачного резервного копирования!**
